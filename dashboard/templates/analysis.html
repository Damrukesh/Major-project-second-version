<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Energy Forecast Analysis</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <style>
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      height: 450px;
    }

    .chart-container canvas {
      max-height: 350px;
    }

    .chart-container h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .summary-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .summary-card h4 {
      margin: 0 0 10px 0;
      color: #495057;
      font-size: 0.9rem;
    }

    .summary-card .value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
    }

    .summary-card .unit {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .positive {
      color: #28a745;
    }

    .negative {
      color: #dc3545;
    }

    .actions {
      display: flex;
      justify-content: space-between;
      margin: 30px 0;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.3s;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }

    .btn:hover {
      background-color: #2980b9;
    }

    .btn-secondary {
      background-color: #6c757d;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .chart-actions {
      margin: 10px 0;
      display: flex;
      gap: 10px;
    }

    .chart-actions button {
      padding: 5px 10px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .chart-actions button:hover {
      background: #e9ecef;
    }

    body {
      background-color: #12161a;
      background-image: url("{{ url_for('static', filename='image.png') }}");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      color: #e0e0e0;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    .hero {
      background: transparent;
      color: #fff;
      padding: 32px 0 20px 0;
      text-align: center;
      border-radius: 0 0 10px 10px;
    }
  </style>
</head>

<body>
  <div class="hero small">
    <h1>Energy Forecast Analysis</h1>
    <p>Detailed analysis of energy demand, renewable generation, and fossil fuel requirements</p>
  </div>

  <main class="container">
    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <h4>Total Energy Saved</h4>
        <div class="value">{{ "%.2f"|format(total_energy_saved_mwh) }}</div>
        <div class="unit">MWh</div>
      </div>
      <div class="summary-card">
        <h4>CO₂ Emissions Avoided</h4>
        <div class="value">{{ "{:,.0f}".format(co2_saved_kg) }}</div>
        <div class="unit">kg CO₂</div>
      </div>
      <div class="summary-card">
        <h4>Renewable Energy Credits</h4>
        <div class="value">{{ "%.1f"|format(recs) }}</div>
        <div class="unit">RECs (MWh)</div>
      </div>
      <div class="summary-card">
        <h4>Renewable Share</h4>
        <div class="value">{{ "%.1f"|format(((wind_forecast|sum) + (solar_forecast|sum) + (hydro_forecast|sum)) /
          ((wind_forecast|length) * 5000) * 100 if wind_forecast|length > 0 else 0) }}%</div>
        <div class="unit">of total generation</div>
      </div>
    </div>

    <div class="dashboard">
      <!-- Fossil Fuel Predicted vs Needed Chart -->
      <div class="chart-container">
        <h3>Fossil Fuel Comparison: Predicted vs Needed</h3>
        <div class="chart-actions">
          <button onclick="resetZoom('fossilPredictedChart')">Reset Zoom</button>
          <button onclick="downloadChart('fossilPredictedChart', 'fossil-predicted-vs-needed')">Download</button>
        </div>
        <canvas id="fossilPredictedChart"></canvas>
        <p class="chart-description">
          Comparison of predicted fossil fuel requirements (purple) versus actually needed fossil fuels (blue) from the
          dataset.
        </p>
      </div>

      <!-- Fossil Production vs Needed Chart -->
      <div class="chart-container">
        <h3>Fossil Fuel Comparison: Production vs Needed</h3>
        <div class="chart-actions">
          <button onclick="resetZoom('fossilProductionChart')">Reset Zoom</button>
          <button onclick="downloadChart('fossilProductionChart', 'fossil-production-vs-needed')">Download</button>
        </div>
        <canvas id="fossilProductionChart"></canvas>
        <p class="chart-description">
          Comparison of actual fossil fuel production (green) versus actually needed fossil fuels (blue) from the
          dataset.
        </p>
      </div>

      <!-- Energy Composition Pie Chart -->
      <div class="chart-container">
        <h3>Energy Composition</h3>
        <div class="chart-actions">
          <button onclick="downloadChart('energyPieChart', 'energy-composition')">Download</button>
        </div>
        <canvas id="energyPieChart"></canvas>
        <p class="chart-description">
          Breakdown of energy sources showing the proportion of each type in the total energy mix.
        </p>
      </div>
    </div>

    <div class="actions">
      <a class="btn" href="{{ url_for('predict') }}">← Back to Forecast</a>
      <div>
        <a class="btn btn-secondary" href="{{ url_for('savings_detail') }}" style="margin-right: 10px;">
          View Detailed Savings
        </a>
        <a class="btn btn-secondary" href="{{ url_for('download_results') }}" style="margin-right: 10px;">
          Download Results
        </a>
        <a class="btn" href="{{ url_for('index') }}">
          New Prediction
        </a>
      </div>
    </div>
  </main>

  <script>
    // Chart configuration
    const config = {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += context.parsed.y.toFixed(2) + ' MW';
              }
              return label;
            }
          }
        },
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Hour' } },
        y: {
          title: { display: true, text: 'Power (MW)' },
          beginAtZero: true
        }
      }
    };

    // Fossil Fuel Predicted vs Needed Chart
    const fossilPredictedCtx = document.getElementById('fossilPredictedChart').getContext('2d');
    const fossilPredictedChart = new Chart(fossilPredictedCtx, {
      type: 'line',
      data: {
        labels: {{ timestamps| tojson }},
    datasets: [
      {
        label: 'Predicted Fossil Fuels (from Analysis)',
        data: {{ fossil_predicted| tojson }},
      borderColor: 'rgba(128, 0, 128, 0.9)',  // Purple
      backgroundColor: 'rgba(128, 0, 128, 0.1)',
      borderWidth: 2,
      tension: 0.3,
      fill: true
            },
      {
        label: 'Actually Needed Fossil Fuels',
        data: {{ fossil_actual_needed| tojson }},
      borderColor: 'rgba(54, 162, 235, 0.9)',  // Blue
      backgroundColor: 'rgba(54, 162, 235, 0.1)',
      borderWidth: 2,
      tension: 0.3,
      fill: true
            }
    ]
        },
    options: {
          ...config,
        plugins: {
            ...config.plugins,
          title: {
          display: true,
            text: 'Fossil Fuel: Predicted vs Needed (MW)'
        }
      }
    }
      });

    // Fossil Fuel Production vs Needed Chart
    const fossilProductionCtx = document.getElementById('fossilProductionChart').getContext('2d');
    const fossilProductionChart = new Chart(fossilProductionCtx, {
      type: 'line',
      data: {
        labels: {{ timestamps| tojson }},
    datasets: [
      {
        label: 'Actual Fossil Production',
        data: {{ fossil_actual_production| tojson }},
      borderColor: 'rgba(34, 139, 34, 0.9)',  // Green
      backgroundColor: 'rgba(34, 139, 34, 0.1)',
      borderWidth: 2,
      tension: 0.3,
      fill: true
            },
      {
        label: 'Actually Needed Fossil Fuels',
        data: {{ fossil_actual_needed| tojson }},
      borderColor: 'rgba(54, 162, 235, 0.9)',  // Blue
      backgroundColor: 'rgba(54, 162, 235, 0.1)',
      borderWidth: 2,
      tension: 0.3,
      fill: true
            }
    ]
        },
    options: {
          ...config,
        plugins: {
            ...config.plugins,
          title: {
          display: true,
            text: 'Fossil Fuel: Production vs Needed (MW)'
        }
      }
    }
      });

    // Energy Composition Pie Chart
    const energyPieCtx = document.getElementById('energyPieChart').getContext('2d');

    // Calculate totals for each energy source across all 24 hours
    const windTotal = {{ wind_forecast| sum }};
    const solarTotal = {{ solar_forecast| sum }};
    const hydroTotal = {{ hydro_forecast| sum }};
    const nuclearTotal = {{ nuclear_forecast| sum }};
    const fossilTotal = {{ fossil_predicted| sum }};

    const energyPieChart = new Chart(energyPieCtx, {
      type: 'pie',
      data: {
        labels: ['Wind', 'Solar', 'Hydro', 'Nuclear', 'Fossil'],
        datasets: [{
          data: [windTotal, solarTotal, hydroTotal, nuclearTotal, fossilTotal],
          backgroundColor: [
            'rgba(75, 192, 192, 0.8)',   // Wind - Teal
            'rgba(255, 206, 86, 0.8)',   // Solar - Yellow
            'rgba(54, 162, 235, 0.8)',   // Hydro - Blue
            'rgba(153, 102, 255, 0.8)',  // Nuclear - Purple
            'rgba(255, 99, 132, 0.8)'    // Fossil - Red
          ],
          borderColor: [
            'rgba(75, 192, 192, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 99, 132, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'right',
          },
          title: {
            display: true,
            text: 'Total Energy Composition (24 Hours)'
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value.toFixed(2)} MWh (${percentage}%)`;
              }
            }
          }
        }
      }
    });

    // Chart utility functions
    function resetZoom(chartId) {
      const chart = Chart.getChart(chartId);
      if (chart) {
        chart.resetZoom();
      }
    }

    function toggleStack(chartId) {
      const chart = Chart.getChart(chartId);
      if (chart) {
        chart.options.scales.y.stacked = !chart.options.scales.y.stacked;
        chart.options.scales.x.stacked = !chart.options.scales.x.stacked;
        chart.update();
      }
    }

    function downloadChart(chartId, filename) {
      const link = document.createElement('a');
      link.download = `${filename}-${new Date().toISOString().split('T')[0]}.png`;
      link.href = document.getElementById(chartId).toDataURL('image/png');
      link.click();
    }
  </script>
</body>

</html>